<h2>题目描述</h2>
<p>IOI 市是一个被分成 <i>r</i> 行，<i>c</i> 列的矩形，每个小矩形都是建筑物、原野、墙壁之一。建筑物的区域有 <i>n</i> 个，编号为 1, 2, ..., <i>n</i>。</p>
<p>scx 只能进入建筑物与原野，而且每次只能走到相邻的区域中，且不能移动到市外。</p>
<p>由于 scx 要做各种各样的事情，必须在各个建筑物之间往返。可是原野上的日光十分强烈，每走过一格原野都需要 1 单位的水。</p>
<p>又原野上没有诸如自动售货机、饮水处之类的东西，因此 IOI 市的市民一般都携带水壶出行。大小为 <i>x</i> 的水壶最多可以装 <i>x</i> 单位的水，所有建筑物里都有水可以将水壶装满。</p>
<p>由于携带大水壶是一件很困难的事情，因此 scx 决定携带尽量小的水壶移动。因此，为了随时能在建筑物之间移动，请你帮她写一个程序来计算最少需要多大的水壶。</p>
<p>现在给出 IOI 市的地图和 <i>q</i> 个询问，第 <i>i</i>个询问为 <span style="color: red">"在建筑物 <i>S<sub>i</sub></i> 和 <i>T<sub>i</sub></i> 之间移动，至少需要多大的水壶？"</span>，请你对于每个询问输出对应的答案。</p>

<h2>输入格式</h2>
<p>第一行包含四个整数 <i>r</i>, <i>c</i>, <i>n</i>, <i>q</i>，意义如描述所述。</p>
<p>接下来 <i>r</i> 行，每行有一个长度为 <i>c</i> 的字符串，每个字符都是 <code>.</code> 或 <code>#</code> 之一，<code>.</code>表示这个位置是建筑物或原野，<code>#</code>表示这个位置是和墙壁。</p>
<p>接下来 <i>n</i> 行描述 IOI 市每个建筑物的位置，第 <i>i</i> 行有两个整数 <i>A<sub>i</sub></i> 和 <i>B<sub>i</sub></i>，表示第 <i>i</i> 个建筑物的位置在第 <i>A<sub>i</sub></i> 行第 <i>B<sub>i</sub></i> 列。保证这个位置在地图中是 <code>.</code>。</p>
<p>接下来 <i>q</i> 行，第 <i>i</i> 行有两个空格分隔的整数 <i>S<sub>i</sub></i> 和 <i>T<sub>i</sub></i> ，表示第 <i>i</i> 个询问为 <span style="color: red">"在建筑物 <i>S<sub>i</sub></i> 和 <i>T<sub>i</sub></i> 之间移动，至少需要多大的水壶？"</span></p>

<h2>输出格式</h2>
<p>输出 <i>q</i> 行，第 <i>i</i> 行的整数表示在建筑物 <i>S<sub>i</sub></i> 和 <i>T<sub>i</sub></i> 之间移动至少需要多大的水壶。如果无法到达，输出 <code>-1</code>。此外，如果不需要经过原野就能到达，输出 <code>0</code>。

<h2>题解</h2>
<p>可以比较显然滴发现，可以将 <i>n</i> 个建筑物看成 <i>n</i> 个节点，点 <i>S<sub>i</sub></i> 和点 <i>T<sub>i</sub></i> 的答案就是最小生成树中 <i>S<sub>i</sub></i> 到 <i>T<sub>i</sub></i> 的路径中最大边的权值。</p>
<p>然后就是建立 Minimum Spanning Tree 了。</p>
<p>而原图的节点数为 2 × 10<sup>5</sup>，如果两两连边，则边数最大为 2 × 10<sup>10</sup>，<s>那么即使是 <img src="http://latex.codecogs.com/gif.latex?\Theta(|E|)"> 的最小生成树算法估计都过不去</s>，所以需要探究图本身的性质。</p>
<p>由于该图在一个平面上的，所以我们可以设法将它变成一个平面图后再跑生成树。那么我们可以采用 bfs，以每个建筑物 (节点) 为圆心按照 Manhattan 距离扩展，如果两个建筑物在扩展时碰到了，再连边，这样就得到了一个平面图。</p>
<p>(scx: 可是节点数有 2 × 10<sup>5</sup> 啊！保证边数不会太大吗？)</p>
<p>不会的，平面图有一个定理：<img src="http://latex.codecogs.com/gif.latex?|E|\leq3|V|-6">，证明可以在<s>任何一本涉及到平面图的书中找到</s>。也就是说，<b style="color: red">在平面图中，边数和点数呈线性关系</b>。</p>
<p>然后跑完 Kruskal (或 Prim 或其它) 后，就是两点路径的最大边。</p>
<p>然而这玩意儿，就可以用像 LCA 一样的 <s>(其实就是 LCA 模板改一改)</s> 倍增算法在单次询问 <img src="http://latex.codecogs.com/gif.latex?\Theta(\log|V|)"> 时间内算出来。<s>(听说有一种高端的长链剖分可以做到单次询问 </s><img src="http://latex.codecogs.com/gif.latex?\Theta(1)">)</p>
<p>不过要注意的是，由于墙壁可能非常多导致某两个建筑物之间无法到达 <s>(scx 一定很着急)</s>，因此需要最后询问的时候，如果两个点不在同一个可到达集合中，就直接输出 -1 啦 (所以还是推荐写 Kruskal 吧，顺便就把并查集建出来了)。</p>

<h2>代码</h2>

<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> S <span class="sh_number">2034</span>
<span class="sh_preproc">#define</span> S2 <span class="sh_number">4012249</span>
<span class="sh_preproc">#define</span> maxV <span class="sh_number">256101</span>
<span class="sh_preproc">#define</span> maxE <span class="sh_number">4012249</span>
<span class="sh_preproc">#define</span> <span class="sh_function">ID</span><span class="sh_symbol">(</span>x<span class="sh_symbol">)</span> id<span class="sh_symbol">[</span>x<span class="sh_symbol">.</span>r<span class="sh_symbol">][</span>x<span class="sh_symbol">.</span>c<span class="sh_symbol">]</span>
<span class="sh_preproc">#define</span> <span class="sh_function">F</span><span class="sh_symbol">(</span>x<span class="sh_symbol">)</span> f<span class="sh_symbol">[</span>x<span class="sh_symbol">.</span>r<span class="sh_symbol">][</span>x<span class="sh_symbol">.</span>c<span class="sh_symbol">]</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">pr</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> r<span class="sh_symbol">,</span> c<span class="sh_symbol">;</span>
    <span class="sh_function">pr</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> r0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> c0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">):</span> <span class="sh_function">r</span><span class="sh_symbol">(</span>r0<span class="sh_symbol">),</span> <span class="sh_function">c</span><span class="sh_symbol">(</span>c0<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
    <span class="sh_usertype">pr</span><span class="sh_normal"> </span><span class="sh_symbol">*</span><span class="sh_function">scan</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span><span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>r<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>c<span class="sh_symbol">);</span> <span class="sh_keyword">return</span> <span class="sh_keyword">this</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">edge</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> u<span class="sh_symbol">,</span> v<span class="sh_symbol">,</span> w<span class="sh_symbol">;</span>
    <span class="sh_function">edge</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> u0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> v0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> w0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">):</span> <span class="sh_function">u</span><span class="sh_symbol">(</span>u0<span class="sh_symbol">),</span> <span class="sh_function">v</span><span class="sh_symbol">(</span>v0<span class="sh_symbol">),</span> <span class="sh_function">w</span><span class="sh_symbol">(</span>w0<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
    <span class="sh_type">bool</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;</span> <span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_usertype">edge</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">)</span> <span class="sh_keyword">const</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> w <span class="sh_symbol">&lt;</span> b<span class="sh_symbol">.</span>w<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">UFind</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> sz<span class="sh_symbol">,</span> <span class="sh_symbol">*</span>p<span class="sh_symbol">;</span>
    <span class="sh_function">UFind</span> <span class="sh_symbol">():</span> <span class="sh_function">sz</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>p <span class="sh_symbol">=</span> NULL<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_symbol">~</span><span class="sh_function">UFind</span> <span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>p<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>p<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_type">int</span> size<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>p<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>p<span class="sh_symbol">);</span> p <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> <span class="sh_type">int</span><span class="sh_symbol">[(</span>sz <span class="sh_symbol">=</span> size<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">];</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">int</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> sz<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> p<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> i<span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> x <span class="sh_symbol">==</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">?</span> x <span class="sh_symbol">:</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>p<span class="sh_symbol">[</span>x<span class="sh_symbol">]);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">bool</span> <span class="sh_function">test</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">,</span> <span class="sh_type">bool</span> un <span class="sh_symbol">=</span> <span class="sh_keyword">false</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">((</span>x <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>x<span class="sh_symbol">))</span> <span class="sh_symbol">==</span> <span class="sh_symbol">(</span>y <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>y<span class="sh_symbol">)))</span> <span class="sh_keyword">return</span> <span class="sh_keyword">false</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>un<span class="sh_symbol">)</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span> <span class="sh_keyword">return</span> <span class="sh_keyword">true</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_keyword">const</span> <span class="sh_type">int</span> dr<span class="sh_symbol">[</span><span class="sh_number">4</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_cbracket">{</span><span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_cbracket">}</span><span class="sh_symbol">;</span>
<span class="sh_keyword">const</span> <span class="sh_type">int</span> dc<span class="sh_symbol">[</span><span class="sh_number">4</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_cbracket">{</span><span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_comment">// E0: planar graph, Es: minimum spanning tree</span>
<span class="sh_type">int</span> R<span class="sh_symbol">,</span> C<span class="sh_symbol">,</span> V<span class="sh_symbol">,</span> E0<span class="sh_symbol">,</span> Es<span class="sh_symbol">;</span>
<span class="sh_type">int</span> q<span class="sh_symbol">,</span> u<span class="sh_symbol">,</span> v<span class="sh_symbol">,</span> i<span class="sh_symbol">;</span>
<span class="sh_comment">// map[i][j]</span>
<span class="sh_type">char</span> m<span class="sh_symbol">[</span>S<span class="sh_symbol">][</span>S<span class="sh_symbol">];</span>
<span class="sh_comment">// for bfs, id[i][j]: the owner of point (i, j), f[i][j]: distance from (i, j) to id[i][j]</span>
<span class="sh_type">int</span> f<span class="sh_symbol">[</span>S<span class="sh_symbol">][</span>S<span class="sh_symbol">],</span> id<span class="sh_symbol">[</span>S<span class="sh_symbol">][</span>S<span class="sh_symbol">];</span>
<span class="sh_usertype">pr</span><span class="sh_normal"> </span>a<span class="sh_symbol">[</span>maxV<span class="sh_symbol">],</span> que<span class="sh_symbol">[</span>S2<span class="sh_symbol">];</span>
<span class="sh_comment">// adjacent list</span>
<span class="sh_usertype">edge</span><span class="sh_normal"> </span>e0<span class="sh_symbol">[</span>maxE <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">],</span> es<span class="sh_symbol">[</span>maxV <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">];</span>
<span class="sh_type">int</span> first<span class="sh_symbol">[</span>maxV<span class="sh_symbol">],</span> next<span class="sh_symbol">[</span>maxV <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">];</span>
<span class="sh_comment">// union find</span>
<span class="sh_usertype">UFind</span><span class="sh_normal"> </span>uf<span class="sh_symbol">;</span>
<span class="sh_comment">// for dfs</span>
<span class="sh_type">int</span> dep<span class="sh_symbol">[</span>maxV<span class="sh_symbol">],</span> P<span class="sh_symbol">[</span>maxV<span class="sh_symbol">][</span><span class="sh_number">19</span><span class="sh_symbol">],</span> D<span class="sh_symbol">[</span>maxV<span class="sh_symbol">][</span><span class="sh_number">19</span><span class="sh_symbol">];</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">up</span><span class="sh_symbol">(</span><span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>x <span class="sh_symbol">&lt;</span> y <span class="sh_symbol">?</span> x <span class="sh_symbol">=</span> y <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span> 
<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">addedge0</span><span class="sh_symbol">(</span><span class="sh_type">int</span> u<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">,</span> <span class="sh_type">int</span> w<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>e0<span class="sh_symbol">[</span>E0 <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">].</span>u <span class="sh_symbol">==</span> u <span class="sh_symbol">&amp;&amp;</span> e0<span class="sh_symbol">[</span>E0 <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">].</span>v <span class="sh_symbol">==</span> v<span class="sh_symbol">)</span> <span class="sh_keyword">return</span><span class="sh_symbol">;</span>
    e0<span class="sh_symbol">[++</span>E0<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">edge</span><span class="sh_symbol">(</span>u<span class="sh_symbol">,</span> v<span class="sh_symbol">,</span> w<span class="sh_symbol">);</span> e0<span class="sh_symbol">[++</span>E0<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">edge</span><span class="sh_symbol">(</span>v<span class="sh_symbol">,</span> u<span class="sh_symbol">,</span> w<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>
<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">addedges</span><span class="sh_symbol">(</span><span class="sh_type">int</span> u<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">,</span> <span class="sh_type">int</span> w<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    es<span class="sh_symbol">[++</span>Es<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">edge</span><span class="sh_symbol">(</span>u<span class="sh_symbol">,</span> v<span class="sh_symbol">,</span> w<span class="sh_symbol">);</span> next<span class="sh_symbol">[</span>Es<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>u<span class="sh_symbol">];</span> first<span class="sh_symbol">[</span>u<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> Es<span class="sh_symbol">;</span>
    es<span class="sh_symbol">[++</span>Es<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">edge</span><span class="sh_symbol">(</span>v<span class="sh_symbol">,</span> u<span class="sh_symbol">,</span> w<span class="sh_symbol">);</span> next<span class="sh_symbol">[</span>Es<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>v<span class="sh_symbol">];</span> first<span class="sh_symbol">[</span>v<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> Es<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">bfs</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> h<span class="sh_symbol">,</span> t<span class="sh_symbol">,</span> i<span class="sh_symbol">;</span>
    <span class="sh_usertype">pr</span><span class="sh_normal"> </span>z1<span class="sh_symbol">,</span> z2<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>E0 <span class="sh_symbol">=</span> t <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> t <span class="sh_symbol">&lt;</span> V<span class="sh_symbol">;</span> t<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>que<span class="sh_symbol">[</span>t<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> a<span class="sh_symbol">[</span>t <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">];</span> <span class="sh_function">ID</span><span class="sh_symbol">(</span>a<span class="sh_symbol">[</span>t <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">])</span> <span class="sh_symbol">=</span> t <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>h <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> h <span class="sh_symbol">&lt;</span> t<span class="sh_symbol">;</span> h<span class="sh_symbol">++)</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>z1 <span class="sh_symbol">=</span> que<span class="sh_symbol">[</span>h<span class="sh_symbol">],</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">4</span><span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>    
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>m<span class="sh_symbol">[</span>z2<span class="sh_symbol">.</span>r <span class="sh_symbol">=</span> z1<span class="sh_symbol">.</span>r <span class="sh_symbol">+</span> dr<span class="sh_symbol">[</span>i<span class="sh_symbol">]][</span>z2<span class="sh_symbol">.</span>c <span class="sh_symbol">=</span> z1<span class="sh_symbol">.</span>c <span class="sh_symbol">+</span> dc<span class="sh_symbol">[</span>i<span class="sh_symbol">]]</span> <span class="sh_symbol">!=</span> <span class="sh_string">'.'</span><span class="sh_symbol">)</span> <span class="sh_keyword">continue</span><span class="sh_symbol">;</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(!</span><span class="sh_function">ID</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">))</span><span class="sh_cbracket">{</span>
                <span class="sh_function">ID</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">)</span> <span class="sh_symbol">=</span> <span class="sh_function">ID</span><span class="sh_symbol">(</span>z1<span class="sh_symbol">);</span> <span class="sh_function">F</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">)</span> <span class="sh_symbol">=</span> <span class="sh_function">F</span><span class="sh_symbol">(</span>z1<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
                que<span class="sh_symbol">[</span>t<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> z2<span class="sh_symbol">;</span>
            <span class="sh_cbracket">}</span><span class="sh_keyword">else</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span><span class="sh_function">ID</span><span class="sh_symbol">(</span>z1<span class="sh_symbol">)</span> <span class="sh_symbol">&lt;</span> <span class="sh_function">ID</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">))</span>
                <span class="sh_function">addedge0</span><span class="sh_symbol">(</span><span class="sh_function">ID</span><span class="sh_symbol">(</span>z1<span class="sh_symbol">),</span> <span class="sh_function">ID</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">),</span> <span class="sh_function">F</span><span class="sh_symbol">(</span>z1<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_function">F</span><span class="sh_symbol">(</span>z2<span class="sh_symbol">));</span>
        <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">Kruskal</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    uf<span class="sh_symbol">.</span><span class="sh_function">resize</span><span class="sh_symbol">(</span>V<span class="sh_symbol">);</span>
    <span class="sh_function">sort</span><span class="sh_symbol">(</span>e0 <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> e0 <span class="sh_symbol">+</span> <span class="sh_symbol">(</span>E0 <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">));</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>Es <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> E0<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>uf<span class="sh_symbol">.</span><span class="sh_function">test</span><span class="sh_symbol">(</span>e0<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>u<span class="sh_symbol">,</span> e0<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>v<span class="sh_symbol">,</span> <span class="sh_keyword">true</span><span class="sh_symbol">))</span><span class="sh_cbracket">{</span>
            <span class="sh_function">addedges</span><span class="sh_symbol">(</span>e0<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>u<span class="sh_symbol">,</span> e0<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>v<span class="sh_symbol">,</span> e0<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>w<span class="sh_symbol">);</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>Es <span class="sh_symbol">&gt;=</span> V <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_keyword">return</span><span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> y<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">18</span> <span class="sh_symbol">&amp;&amp;</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
        P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">][</span>P<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
        D<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">max</span><span class="sh_symbol">(</span>D<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">],</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">][</span>D<span class="sh_symbol">][</span>i<span class="sh_symbol">]);</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span> i<span class="sh_symbol">;</span> i <span class="sh_symbol">=</span> next<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">((</span>y <span class="sh_symbol">=</span> es<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>v<span class="sh_symbol">)</span> <span class="sh_symbol">!=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">])</span><span class="sh_cbracket">{</span>
            P<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">;</span> D<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> es<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>w<span class="sh_symbol">;</span>
            dep<span class="sh_symbol">[</span>y<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">query</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>uf<span class="sh_symbol">.</span><span class="sh_function">test</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> y<span class="sh_symbol">))</span> <span class="sh_keyword">return</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_type">int</span> res <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> dep<span class="sh_symbol">[</span>y<span class="sh_symbol">])</span> <span class="sh_function">swap</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> y<span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">18</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i<span class="sh_symbol">--)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> i<span class="sh_symbol">)</span> <span class="sh_symbol">&gt;=</span> dep<span class="sh_symbol">[</span>y<span class="sh_symbol">])</span><span class="sh_cbracket">{</span>
            <span class="sh_function">up</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> D<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">]);</span> x <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>x <span class="sh_symbol">==</span> y<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> res<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">18</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i<span class="sh_symbol">--)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">!=</span> P<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span>i<span class="sh_symbol">])</span><span class="sh_cbracket">{</span>
            <span class="sh_function">up</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> D<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">]);</span> x <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
            <span class="sh_function">up</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> D<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span>i<span class="sh_symbol">]);</span> y <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_function">up</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> D<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]);</span> <span class="sh_function">up</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> D<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]);</span> 
    <span class="sh_keyword">return</span> res<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>R<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>C<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>V<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>q<span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> R<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%s"</span><span class="sh_symbol">,</span> m<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> V<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> a<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span><span class="sh_function">scan</span><span class="sh_symbol">();</span>
    <span class="sh_function">bfs</span><span class="sh_symbol">();</span>
    <span class="sh_function">Kruskal</span><span class="sh_symbol">();</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> V<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(!</span>dep<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span><span class="sh_cbracket">{</span>dep<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span>i<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> q<span class="sh_symbol">;</span> q<span class="sh_symbol">--)</span><span class="sh_cbracket">{</span>
        <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>u<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>v<span class="sh_symbol">);</span>
        <span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%d</span><span class="sh_specialchar">\n</span><span class="sh_string">"</span><span class="sh_symbol">,</span> <span class="sh_function">query</span><span class="sh_symbol">(</span>u<span class="sh_symbol">,</span> v<span class="sh_symbol">));</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h2>坑</h2>
<p><b>坑1：</b>bfs 建立边的时候，记得去重，不然可能会有过多重边，去重时可以增加限制条件比如说 <i>u</i> &lt; <i>v</i> 啊等等，又因为是 bfs，所以相同路径的同一条边会在一起出现，所以可以增加<b>判 "上一条边" 去重</b>，虽然还是有少量重边，但是优化已经很明显了，实际边数不超过 3<i>n</i> - 6 大概是 6 × 10<sup>5</sup>，优化后 (带重边) 的边数也已经不超过两三百万，完全可以存下来。</p>
<p><b>坑2：</b>无向图开边 × 2 不解释。</p>
<p><b>坑3：</b>题解中已提到，如果无法到达，需要输出 <code>-1</code>，这可以在并查集中轻松得到，说句题外话，这好像是我第一次把并查集 (Union-Find) 给封装起来了，搞了一个 test 函数为询问是否在不同连通块并决定是否连接，具体见代码或模板。</p>
