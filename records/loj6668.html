<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<link type="text/css" rel="stylesheet" href="../additional_files/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="../additional_files/sh_typical.min.css">
		<title>[loj6668]三个愿望一次满足</title>
		<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}});</script>
		<script src="../additional_files/sh_main.min.js"></script>
		<script src="../additional_files/MathJax-master/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	</head>
	<body>
		<h3>题目描述</h3>
		<p>设 $\displaystyle f \left( n \right) = \prod_{i=1}^n \left( 2 i - 1 \right)$，给定 $n, m, x$，求：$$ \sum_{i=0}^n \sum_{j=0}^m f \left( i \oplus j \oplus x \right) $$</p>
		<p>特别地，定义 $f \left( 0 \right) = 0$。</p>
		<p>由于答案巨大无比，因此你只需要使用 <code>unsigned int</code> 自然溢出即可。</p>

		<h3>输入格式</h3>
		<p>共一行，包含三个正整数 $n, m, x$ ($n, m, x \leq 2^{30}$)。</p>

		<h3>输出格式</h3>
		<p>输出一行一个整数，表示上式模 $2^{32}$ 的值。</p>

		<h3>题解</h3>
		<p>考虑这个和式，设 $2^\alpha \mid A; 2^\beta \mid B$，则当 $A \leq i &lt; A + 2^\mu, B \leq j &lt; B + 2^\nu$ ($\mu &lt; A; \nu &lt; B$，并不妨设 $\mu \geq \nu$)，当 $i$ 从 $A$ 到 $A + 2^\mu - 1$ 变动时，$i \oplus j \oplus x$ 的末 $\mu$ 位跑遍了所有的 $\mu$ 位 $\texttt 0/\texttt 1$ 串。</p>
		<p>由于 $\nu \leq \mu$，因此当 $j$ 变动时，$i \oplus j \oplus x$ 至多变动末 $\mu$ 位。因此，对于固定的 $j$，对 $i$ 求和的结果是相同的。</p>
		<p>更精确地，设 $A \oplus B \oplus x$ 将末 $\mu$ 位置 $0$ 的结果为 $R$，则原式就等于 $$ 2^\nu \cdot \sum_{i=0}^{2^\mu - 1} f \left( R + i \right) $$</p>
		<p><em>即 $f$ 函数的两个<strong>部分和</strong>的<strong>差</strong>。</em></p>
		<p>因此，我们将整个和式按照 $A, B$ 的二进制表示分为 $O \left( \log n \cdot \log m \right)$ 组，每组都是 $f$ 函数一段区间和，即两个部分和之差。</p>
		<p>因此下面的主要任务就是 (较为) 快速地计算 $f$ 函数的部分和：$$ F \left( n \right) = \sum_{i=1}^n f \left( i \right) \sum_{i=1}^n \prod_{j=1}^i f \left( 2 j + 1 \right) $$</p>
		<p>由于是模 $2^{32}$ (素数幂)，因此和 <a href="1.%20math.html" target="_blank">math 这道题</a> 类似，考虑构造多项式。</p>
		<p>记 $p_1 \left( x \right) = 2 x + 1, p_2 \left( x \right) = \left( 2 x + 1 \right) \left( 2 x + 3 \right) = p_1 \left( x \right) p_1 \left( x + 1 \right), p_3 \left( x \right) = \left( 2 x + 1 \right) \left( 2 x + 3 \right) \left( 2 x + 5 \right) \left( 2 x + 7 \right) = p_2 \left( x \right) p_2 \left( x + 2 \right)$，……，以此类推，$p_{n + 1} \left( x \right) = p_n \left( x \right) p_n \left( x + 2^{n-1} \right)$。</p>
		<p>由于所有运算在模 $2^{32}$ 下进行，且 $x^{32}$ 以及更高次项的系数模 $2^{32}$ 均为 $0$，因此我们可以将 $p_n \left( x \right)$ 视为一个<strong>不超过 $31$ 次的多项式</strong>。</p>
		<p>另一方面，$p_j \left( x \right)$ 表示从 $2 x$ 开始连续 $2^{j-1}$ 个奇数的乘积 (模 $2^{32}$ 的值)，因此区间奇数的乘积就可以通过倍增 (分治/二进制) 的思想在 $O \left( 32 \log n \right) \sim O \left( \log^2 n \right)$ 时间内得到。</p>
		<p>同理，设 $\displaystyle q_j \left( x \right) = \sum_{i=0}^{2^{j-1} - 1} \left( 2 x + 1 \right) \left( 2 x + 3 \right) \cdots \left( 2 x + \left( 2 i + 1 \right) \right)$，则有 $q_{n+1} \left( x \right) = q_n \left( x \right) + p_n \left( x \right) q_n \left( x + 2^{n-1} \right)$。</p>
		<p>类似地，$q_n \left( x \right)$ 也可以视作一个次数不超过 $31$ 的多项式。</p>
		<p>因此，可以在 $O \left( \operatorname{poly} \left( \log n \right) \right)$ 的时间内预处理出这些多项式<del>或像我一样直接打表</del>。</p>
		<p>于是单点查值的复杂度仍然是 $O \left( \log^2 n \right)$。</p>
		<p>最终由于需要对 $O \left( \log n \cdot \log m \right)$ 组点值进行查询，因此复杂度为 $O \left( \log^4 n \right)$。</p>
		<p>不过事实上，这些点值有大量是相同的。通过更细致的分析后，可以发现，本质不同的点值只有 $O \left( \log n + \log m \right)$ 组，因此总时间复杂度就是 $O \left( \log^3 n \right)$。(不计预处理时间)。</p>

		<h3>代码</h3>

		<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp">#include &lt;bits/stdc++.h&gt;

typedef unsigned int u32;
typedef std::pair &lt;u32, u32&gt; pr;
typedef std::map &lt;u32, u32&gt; map;

const u32 cf[32][32] = {
	{},
	{0x1, 0x2},
	{0x3, 0x8, 0x4},
	{0x69, 0x160, 0x158, 0x80, 0x10},
	{0x1eee11, 0x7d1180, 0xb27a30, 0x7eb600, 0x32cb60, 0xc0800, 0x1ab00, 0x2000, 0x100},
	{0x62ea3521, 0xf791a600, 0xb044da60, 0x8db97800, 0x3c9ecbc0, 0x9c76e000, 0xd59e7a00, 0x68698000, 0x4b51a600, 0x16120000, 0xad86a000, 0xfde80000, 0xd04fc000, 0x15a00000, 0x1d560000, 0x800000, 0x10000},
	{0x22e76e41, 0x6be19800, 0xf20d0cc0, 0x926ae000, 0x42f1ab80, 0xc8398000, 0x40cb4400, 0x6b2e0000, 0x4d565c00, 0xb1f80000, 0x7f1cc000, 0xe600000, 0x5688000, 0xc7800000, 0x50e40000, 0x6000000, 0x5d060000, 0xc8000000, 0xf4400000, 0xa0000000, 0x60800000, 0x80000000, 0x2c000000, 0, 0xdc000000, 0, 0x40000000, 0, 0x80000000},
	{0x32afec81, 0xc35e6000, 0xe17d7980, 0x6ed38000, 0x4c1da700, 0x8e560000, 0x6bbdc800, 0x14f80000, 0xec14f800, 0xd7600000, 0x7bdf8000, 0x47800000, 0x21850000, 0xa6000000, 0x3aa80000, 0x38000000, 0xd59c0000, 0xe0000000, 0xcb800000, 0x80000000, 0x37000000, 0, 0xa8000000, 0, 0xc8000000, 0, 0x80000000},
	{0x1e0c1901, 0x9c398000, 0xc6b87300, 0x748e0000, 0xfb748e00, 0x4cd80000, 0x8d889000, 0x55e00000, 0xe2af000, 0xf9800000, 0x2d970000, 0xe000000, 0x9e5a0000, 0xd8000000, 0xa8d00000, 0xe0000000, 0xcd780000, 0x80000000, 0x33000000, 0, 0xe6000000, 0, 0x90000000, 0, 0xd0000000},
	{0x50093201, 0xe6e60000, 0x45e6e600, 0x9c380000, 0xc64e1c00, 0x4f600000, 0x3ec52000, 0x67800000, 0x2f59e000, 0xc6000000, 0x6c8e0000, 0xb8000000, 0xedf40000, 0x60000000, 0x9fa00000, 0x80000000, 0x43f00000, 0, 0x56000000, 0, 0xac000000, 0, 0x20000000, 0, 0xa0000000},
	{0xf9d66401, 0x4b980000, 0x39a5cc00, 0xc0e00000, 0xde303800, 0x1d800000, 0x685a4000, 0x1e000000, 0x2c3c000, 0x18000000, 0xee9c0000, 0xe0000000, 0xc0e80000, 0x80000000, 0x77400000, 0, 0x2be00000, 0, 0x6c000000, 0, 0xd8000000, 0, 0x40000000, 0, 0x40000000},
	{0xaabcc801, 0xae600000, 0x8aab9800, 0x83800000, 0xa2b07000, 0x76000000, 0x5bf48000, 0x78000000, 0x55c78000, 0x60000000, 0xb3380000, 0x80000000, 0x15d00000, 0, 0xce800000, 0, 0xe7c00000, 0, 0xd8000000, 0, 0xb0000000, 0, 0x80000000, 0, 0x80000000},
	{0xb1b99001, 0xb9800000, 0x72d73000, 0xe000000, 0xdea0e000, 0xd8000000, 0xe4e90000, 0xe0000000, 0xec8f0000, 0x80000000, 0xbe700000, 0, 0x7ba00000, 0, 0x1d000000, 0, 0xf800000, 0, 0xb0000000, 0, 0x60000000},
	{0xd4732001, 0xe6000000, 0x5bae6000, 0x38000000, 0x2241c000, 0x60000000, 0x7dd20000, 0x80000000, 0xdd1e0000, 0, 0xdce00000, 0, 0x37400000, 0, 0x3a000000, 0, 0x1f000000, 0, 0x60000000, 0, 0xc0000000},
	{0x6ce64001, 0x98000000, 0x8f5cc000, 0xe0000000, 0xd8838000, 0x80000000, 0xcba40000, 0, 0xca3c0000, 0, 0x39c00000, 0, 0x6e800000, 0, 0x74000000, 0, 0x3e000000, 0, 0xc0000000, 0, 0x80000000},
	{0xe9cc8001, 0x60000000, 0x7eb98000, 0x80000000, 0x1070000, 0, 0xd7480000, 0, 0xd4780000, 0, 0x73800000, 0, 0xdd000000, 0, 0xe8000000, 0, 0x7c000000, 0, 0x80000000},
	{0x13990001, 0x80000000, 0x7d730000, 0, 0x420e0000, 0, 0xae900000, 0, 0xa8f00000, 0, 0xe7000000, 0, 0xba000000, 0, 0xd0000000, 0, 0xf8000000},
	{0x27320001, 0, 0xfae60000, 0, 0x841c0000, 0, 0x5d200000, 0, 0x51e00000, 0, 0xce000000, 0, 0x74000000, 0, 0xa0000000, 0, 0xf0000000},
	{0x4e640001, 0, 0xf5cc0000, 0, 0x8380000, 0, 0xba400000, 0, 0xa3c00000, 0, 0x9c000000, 0, 0xe8000000, 0, 0x40000000, 0, 0xe0000000},
	{0x9cc80001, 0, 0xeb980000, 0, 0x10700000, 0, 0x74800000, 0, 0x47800000, 0, 0x38000000, 0, 0xd0000000, 0, 0x80000000, 0, 0xc0000000},
	{0x39900001, 0, 0xd7300000, 0, 0x20e00000, 0, 0xe9000000, 0, 0x8f000000, 0, 0x70000000, 0, 0xa0000000, 0, 0, 0, 0x80000000},
	{0x73200001, 0, 0xae600000, 0, 0x41c00000, 0, 0xd2000000, 0, 0x1e000000, 0, 0xe0000000, 0, 0x40000000},
	{0xe6400001, 0, 0x5cc00000, 0, 0x83800000, 0, 0xa4000000, 0, 0x3c000000, 0, 0xc0000000, 0, 0x80000000},
	{0xcc800001, 0, 0xb9800000, 0, 0x7000000, 0, 0x48000000, 0, 0x78000000, 0, 0x80000000},
	{0x99000001, 0, 0x73000000, 0, 0xe000000, 0, 0x90000000, 0, 0xf0000000},
	{0x32000001, 0, 0xe6000000, 0, 0x1c000000, 0, 0x20000000, 0, 0xe0000000},
	{0x64000001, 0, 0xcc000000, 0, 0x38000000, 0, 0x40000000, 0, 0xc0000000},
	{0xc8000001, 0, 0x98000000, 0, 0x70000000, 0, 0x80000000, 0, 0x80000000},
	{0x90000001, 0, 0x30000000, 0, 0xe0000000},
	{0x20000001, 0, 0x60000000, 0, 0xc0000000},
	{0x40000001, 0, 0xc0000000, 0, 0x80000000},
	{0x80000001, 0, 0x80000000}
}, cF[32][32] = {
	{},
	{0x1, 0x2},
	{0x4, 0xa, 0x4},
	{0x7c, 0x198, 0x180, 0x88, 0x10},
	{0x212ab8, 0x85c8f0, 0xbe1b00, 0x862b90, 0x356060, 0xc8640, 0x1b780, 0x2080, 0x100},
	{0x55a9b070, 0x42e530e0, 0xca4d6600, 0xcef3920, 0xaf710dc0, 0x7373fd80, 0x7dfacd00, 0x67af8b00, 0xd8c53600, 0x7574d000, 0x1cfda000, 0xc2640000, 0x30d84000, 0x20fbc000, 0x1d8e8000, 0x808000, 0x10000},
	{0xb4c36ce0, 0x9279dc0, 0x75db8c00, 0xba7b3a40, 0xa3a5af80, 0xe5127f00, 0xd5d51200, 0xe6b27e00, 0x386b3c00, 0xd422e000, 0xf6e7c000, 0x1a3d0000, 0xfeab8000, 0x68c68000, 0xf5570000, 0x3e230000, 0x81e60000, 0x1f400000, 0x98000000, 0xd0c00000, 0xf0800000, 0x97000000, 0x72000000, 0x96000000, 0x9c000000, 0x30000000, 0x20000000, 0x60000000, 0, 0xc0000000, 0x80000000, 0x80000000},
	{0xeb8c09c0, 0xd9222b80, 0x21921800, 0x86b9480, 0x1facaf00, 0xc8850e00, 0x90980400, 0x4ae49c00, 0x2b41b800, 0xe12c000, 0x9dc18000, 0x79060000, 0x33130000, 0xb3e90000, 0x68560000, 0xc18e0000, 0x51dc0000, 0x85800000, 0xb0000000, 0x9a800000, 0x97000000, 0xd2000000, 0x1c000000, 0xd4000000, 0x48000000, 0x20000000, 0xc0000000, 0x40000000, 0, 0x80000000},
	{0xc854d380, 0xb3001700, 0x24d03000, 0xfe3ba900, 0x3769e00, 0x5c3a5c00, 0xc6678800, 0x5557b800, 0x6bf07000, 0xae198000, 0xa64b0000, 0x9afc0000, 0x2b960000, 0x4c420000, 0xf94c0000, 0x9a3c0000, 0x47f80000, 0xf7000000, 0x60000000, 0x49000000, 0xa6000000, 0x74000000, 0x98000000, 0xc8000000, 0xd0000000, 0x40000000, 0x80000000, 0x80000000},
	{0x8edca700, 0x3c6f2e00, 0xda506000, 0x26895200, 0xac223c00, 0xb2b5b800, 0xdad1000, 0x75697000, 0x5394e000, 0xb2030000, 0xdfb60000, 0x9fb80000, 0xe0ec0000, 0x22440000, 0xe5180000, 0x60f80000, 0xf00000, 0x1e000000, 0xc0000000, 0x62000000, 0x2c000000, 0x28000000, 0xb0000000, 0x10000000, 0xa0000000, 0x80000000},
	{0xe0854e00, 0xee9a5c00, 0xc760c000, 0x195aa400, 0x93187800, 0xba6f7000, 0x7ed22000, 0x79bae000, 0x45f9c000, 0xab460000, 0x4bec0000, 0x16700000, 0x88d80000, 0x2b880000, 0x14300000, 0xf3f00000, 0xc5e00000, 0xfc000000, 0x80000000, 0x4000000, 0xd8000000, 0x50000000, 0x60000000, 0x20000000, 0x40000000},
	{0x1c3a9c00, 0x9424b800, 0x59c18000, 0x83d54800, 0x4180f000, 0x28eee000, 0x8b844000, 0x4f15c000, 0x87338000, 0xf38c0000, 0xc9d80000, 0x8e00000, 0x2db00000, 0xf3100000, 0x50600000, 0xafe00000, 0x9bc00000, 0xf8000000, 0, 0x8000000, 0xb0000000, 0xa0000000, 0xc0000000, 0x40000000, 0x80000000},
	{0x25353800, 0x4097000, 0xdf830000, 0x4c2a9000, 0x7041e000, 0x221dc000, 0x4e888000, 0xcab8000, 0xfb670000, 0x5b180000, 0x5bb00000, 0x81c00000, 0xcb600000, 0x56200000, 0x40c00000, 0x7fc00000, 0x77800000, 0xf0000000, 0, 0x10000000, 0x60000000, 0x40000000, 0x80000000, 0x80000000},
	{0xfd6a7000, 0x7712e000, 0x6f060000, 0xaa552000, 0x9583c000, 0x853b8000, 0x7b110000, 0xd3570000, 0xaace0000, 0x86300000, 0xd7600000, 0xc3800000, 0x56c00000, 0x6c400000, 0x1800000, 0x7f800000, 0xef000000, 0xe0000000, 0, 0x20000000, 0xc0000000, 0x80000000},
	{0xc6d4e000, 0xaa25c000, 0x9e0c0000, 0x9caa4000, 0xff078000, 0xe770000, 0x6e220000, 0x8eae0000, 0x259c0000, 0x4c600000, 0x2ec00000, 0x87000000, 0xad800000, 0xd8800000, 0x3000000, 0xff000000, 0xde000000, 0xc0000000, 0, 0x40000000, 0x80000000},
	{0xbda9c000, 0x444b8000, 0x3c180000, 0x59548000, 0x4e0f0000, 0x2cee0000, 0xbc440000, 0xbd5c0000, 0x8b380000, 0x98c00000, 0x5d800000, 0xe000000, 0x5b000000, 0xb1000000, 0x6000000, 0xfe000000, 0xbc000000, 0x80000000, 0, 0x80000000},
	{0x3b538000, 0x48970000, 0x78300000, 0x32a90000, 0xdc1e0000, 0x99dc0000, 0xf8880000, 0xfab80000, 0x16700000, 0x31800000, 0xbb000000, 0x1c000000, 0xb6000000, 0x62000000, 0xc000000, 0xfc000000, 0x78000000},
	{0x76a70000, 0x912e0000, 0xf0600000, 0x65520000, 0xb83c0000, 0x33b80000, 0xf1100000, 0xf5700000, 0x2ce00000, 0x63000000, 0x76000000, 0x38000000, 0x6c000000, 0xc4000000, 0x18000000, 0xf8000000, 0xf0000000},
	{0xed4e0000, 0x225c0000, 0xe0c00000, 0xcaa40000, 0x70780000, 0x67700000, 0xe2200000, 0xeae00000, 0x59c00000, 0xc6000000, 0xec000000, 0x70000000, 0xd8000000, 0x88000000, 0x30000000, 0xf0000000, 0xe0000000},
	{0xda9c0000, 0x44b80000, 0xc1800000, 0x95480000, 0xe0f00000, 0xcee00000, 0xc4400000, 0xd5c00000, 0xb3800000, 0x8c000000, 0xd8000000, 0xe0000000, 0xb0000000, 0x10000000, 0x60000000, 0xe0000000, 0xc0000000},
	{0xb5380000, 0x89700000, 0x83000000, 0x2a900000, 0xc1e00000, 0x9dc00000, 0x88800000, 0xab800000, 0x67000000, 0x18000000, 0xb0000000, 0xc0000000, 0x60000000, 0x20000000, 0xc0000000, 0xc0000000, 0x80000000},
	{0x6a700000, 0x12e00000, 0x6000000, 0x55200000, 0x83c00000, 0x3b800000, 0x11000000, 0x57000000, 0xce000000, 0x30000000, 0x60000000, 0x80000000, 0xc0000000, 0x40000000, 0x80000000, 0x80000000},
	{0xd4e00000, 0x25c00000, 0xc000000, 0xaa400000, 0x7800000, 0x77000000, 0x22000000, 0xae000000, 0x9c000000, 0x60000000, 0xc0000000, 0, 0x80000000, 0x80000000},
	{0xa9c00000, 0x4b800000, 0x18000000, 0x54800000, 0xf000000, 0xee000000, 0x44000000, 0x5c000000, 0x38000000, 0xc0000000, 0x80000000},
	{0x53800000, 0x97000000, 0x30000000, 0xa9000000, 0x1e000000, 0xdc000000, 0x88000000, 0xb8000000, 0x70000000, 0x80000000},
	{0xa7000000, 0x2e000000, 0x60000000, 0x52000000, 0x3c000000, 0xb8000000, 0x10000000, 0x70000000, 0xe0000000},
	{0x4e000000, 0x5c000000, 0xc0000000, 0xa4000000, 0x78000000, 0x70000000, 0x20000000, 0xe0000000, 0xc0000000},
	{0x9c000000, 0xb8000000, 0x80000000, 0x48000000, 0xf0000000, 0xe0000000, 0x40000000, 0xc0000000, 0x80000000},
	{0x38000000, 0x70000000, 0, 0x90000000, 0xe0000000, 0xc0000000, 0x80000000, 0x80000000},
	{0x70000000, 0xe0000000, 0, 0x20000000, 0xc0000000, 0x80000000},
	{0xe0000000, 0xc0000000, 0, 0x40000000, 0x80000000},
	{0xc0000000, 0x80000000, 0, 0x80000000},
};

u32 R, C, x;
map Q;

inline u32 f(u32 d, u32 x) {
	u32 i, ret = 0; assert(!(x &amp; 1)), x /= 2;
	for (i = 31; ~i; --i) ret = ret * x + cf[d][i];
	return ret;
}

inline u32 F(u32 d, u32 x) {
	u32 i, ret = 0; assert(!(x &amp; 1)), x /= 2;
	for (i = 31; ~i; --i) ret = ret * x + cF[d][i];
	return ret;
}

inline u32 compute(u32 x) {
	u32 i, z = 0, ret = 0, base = 1;
	assert(x &amp; 1), ++x;
	for (i = 31; i; --i) if (x &gt;&gt; i &amp; 1) ret += base * F(i, z), base *= f(i, z), z += 1 &lt;&lt; i;
	return ret;
}

int main() {
	u32 i, j, r, width, dup;
	scanf("%u%u%u", &amp;R, &amp;C, &amp;x), ++R, ++C;
	for (i = 0; i &lt;= 30; ++i) if (R &gt;&gt; i &amp; 1)
		for (j = 0; j &lt;= 30; ++j) if (C &gt;&gt; j &amp; 1) {
			std::tie(dup, width) = std::minmax(i, j);
			r = ((R ^ C ^ x ^ 1 &lt;&lt; i ^ 1 &lt;&lt; j) &amp; -1 &lt;&lt; width) - 1;
			Q[r + (1 &lt;&lt; width)] += 1 &lt;&lt; dup, ~r &amp;&amp; (Q[r] -= 1 &lt;&lt; dup);
		}
	r = 0;
	for (const pr &amp;p : Q) if (p.second) r += compute(p.first * 2 - 1) * p.second;
	printf("%u\n", r);
	return 0;
}
</code><script>syntax_highlight()</script>
</pre></div>

		<h3>坑</h3>
		<p><strong>坑1：</strong>由于关于 $i, j$ 的不等式右端是严格的，因此需要先将 $n, m$ 都加上 $1$。</p>
		<p><strong>坑2：</strong>在统计 $R$ ($A \oplus B \oplus x$ 将末 $\mu$ 位置的结果) 的时候注意计算公式，不要算错了。</p>
	</body>
</html>
